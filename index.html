<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QRコードスキャナー</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #000;
      color: white;
      height: 100vh;
    }
    #reader {
      width: 200%;
      max-width: 500px;
      flex-grow: 1;
    }
    #result {
      padding: 1em;
      font-size: 1.2em;
    }
    button {
      padding: 1em 2em;
      font-size: 1.2em;
      margin-top: 1em;
      background-color: #00aaff;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0088cc;
    }
  </style>
</head>
<body>
  <h1>QRスキャナ</h1>
  <button id="start-button">QR</button>
  <div id="reader" style="display:none;"></div>
  <p id="result"></p>

  <script>
    const resultElement = document.getElementById('result');
    const startButton = document.getElementById('start-button');
    const readerDiv = document.getElementById('reader');
    let html5QrCode;

    startButton.addEventListener('click', () => {
      startButton.style.display = 'none';
      readerDiv.style.display = 'block';

      html5QrCode = new Html5Qrcode("reader");
      const config = {
        fps: 30,
        qrbox: { width: 300, height: 300 },
        aspectRatio: 2
      };

      // カメラ一覧を取得して外カメラ（背面）を優先
      Html5Qrcode.getCameras().then(cameras => {
        if (!cameras || cameras.length === 0) {
          resultElement.textContent = "カメラが見つかりませんでした。";
          return;
        }

        // "environment"（背面）に関係ありそうなカメラを選択
        let camera = cameras.find(cam => cam.label.toLowerCase().includes("back"))
                  || cameras.find(cam => cam.label.toLowerCase().includes("environment"))
                  || cameras[0]; // fallback

        html5QrCode.start(
          camera.id,
          config,
          (decodedText, decodedResult) => {
            resultElement.textContent = `読み取り結果: ${decodedText}`;
            html5QrCode.stop().then(() => {
              readerDiv.style.display = 'none';
              startButton.style.display = 'inline-block';
            });
          },
          errorMessage => {
            // スキャン失敗時
          }
        ).catch(err => {
          resultElement.textContent = `カメラの起動に失敗しました: ${err}`;
          readerDiv.style.display = 'none';
          startButton.style.display = 'inline-block';
        });
      }).catch(err => {
        resultElement.textContent = `カメラ取得に失敗しました: ${err}`;
        readerDiv.style.display = 'none';
        startButton.style.display = 'inline-block';
      });
    });
  </script>
</body>
</html>
